### Notification API Tests
### These tests can be used with VS Code REST Client extension

@baseUrl = https://localhost:7001/api/Notification
@adminToken = Bearer <your-admin-token-here>

### 1. Get Hotel Notifications (Admin Only)
GET {{baseUrl}}/hotel/1
Authorization: {{adminToken}}

### 2. Get Hotel Notifications for Hotel 2
GET {{baseUrl}}/hotel/2
Authorization: {{adminToken}}

### 3. Get Pending Notifications (Admin Only)
GET {{baseUrl}}/pending
Authorization: {{adminToken}}

### 4. Get Notification by ID
GET {{baseUrl}}/1
Authorization: {{adminToken}}

### 5. Get Notification Statistics
GET {{baseUrl}}/stats
Authorization: {{adminToken}}

### 6. Manually Trigger Low Capacity Check
POST {{baseUrl}}/trigger/low-capacity-check
Authorization: {{adminToken}}

### 7. Manually Trigger Reservation Processing
POST {{baseUrl}}/trigger/process-reservations
Authorization: {{adminToken}}

### 8. Process Notification Queue Manually
POST {{baseUrl}}/process-queue
Authorization: {{adminToken}}

### TESTING LOW CAPACITY ALERTS

### 9. Setup: Book Most Rooms to Trigger Low Capacity
# First, book 9 out of 10 rooms for a future date
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 1,
  "checkInDate": "2024-05-01T00:00:00Z",
  "checkOutDate": "2024-05-05T00:00:00Z",
  "numberOfRooms": 4,
  "numberOfGuests": 2,
  "guestName": "Test Capacity 1",
  "guestEmail": "test1@example.com",
  "guestPhone": "+1-555-0001"
}

###
# Book more rooms to drop below 20%
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 1,
  "checkInDate": "2024-05-01T00:00:00Z",
  "checkOutDate": "2024-05-05T00:00:00Z",
  "numberOfRooms": 4,
  "numberOfGuests": 2,
  "guestName": "Test Capacity 2",
  "guestEmail": "test2@example.com",
  "guestPhone": "+1-555-0002"
}

###
# Now trigger low capacity check - should find alerts
POST {{baseUrl}}/trigger/low-capacity-check
Authorization: {{adminToken}}

###
# View the generated alerts
GET {{baseUrl}}/hotel/1
Authorization: {{adminToken}}

### TESTING RESERVATION PROCESSING

### 10. Setup: Create New Bookings
# Create a new booking
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 2,
  "checkInDate": "2024-04-10T00:00:00Z",
  "checkOutDate": "2024-04-15T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 2,
  "guestName": "Notification Test User",
  "guestEmail": "notiftest@example.com",
  "guestPhone": "+1-555-9999"
}

###
# Trigger reservation processing
POST {{baseUrl}}/trigger/process-reservations
Authorization: {{adminToken}}

###
# Check pending notifications (should see booking confirmation)
GET {{baseUrl}}/pending
Authorization: {{adminToken}}

###
# Process queue to "send" the notifications
POST {{baseUrl}}/process-queue
Authorization: {{adminToken}}

###
# View all notifications for hotel
GET {{baseUrl}}/hotel/1
Authorization: {{adminToken}}

### INTEGRATED TESTING SCENARIOS

### 11. Complete Low Capacity Alert Flow
# Step 1: Check initial capacity
GET https://localhost:7001/api/HotelSearch/hotels/1?checkInDate=2024-06-01T00:00:00Z&checkOutDate=2024-06-05T00:00:00Z&numberOfGuests=2

###
# Step 2: Book many rooms to reduce capacity
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 1,
  "checkInDate": "2024-06-01T00:00:00Z",
  "checkOutDate": "2024-06-05T00:00:00Z",
  "numberOfRooms": 4,
  "numberOfGuests": 2,
  "guestName": "Heavy Booker",
  "guestEmail": "heavy@example.com",
  "guestPhone": "+1-555-0000"
}

###
# Step 3: Check capacity again
GET https://localhost:7001/api/HotelSearch/hotels/1?checkInDate=2024-06-01T00:00:00Z&checkOutDate=2024-06-05T00:00:00Z&numberOfGuests=2

###
# Step 4: Trigger low capacity check
POST {{baseUrl}}/trigger/low-capacity-check
Authorization: {{adminToken}}

###
# Step 5: View alerts
GET {{baseUrl}}/hotel/1
Authorization: {{adminToken}}

### 12. Complete Reservation Confirmation Flow
# Step 1: Create booking
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 2,
  "roomId": 3,
  "checkInDate": "2024-04-20T00:00:00Z",
  "checkOutDate": "2024-04-25T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 4,
  "guestName": "Miami Visitor",
  "guestEmail": "miami@example.com",
  "guestPhone": "+1-555-3333",
  "specialRequests": "Ocean view preferred"
}

###
# Step 2: Check stats (should show 1 pending if not processed yet)
GET {{baseUrl}}/stats
Authorization: {{adminToken}}

###
# Step 3: Process reservations
POST {{baseUrl}}/trigger/process-reservations
Authorization: {{adminToken}}

###
# Step 4: View hotel notifications (should see confirmation)
GET {{baseUrl}}/hotel/2
Authorization: {{adminToken}}

### 13. Multiple Bookings - Multiple Notifications
# Booking 1
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 1,
  "checkInDate": "2024-07-01T00:00:00Z",
  "checkOutDate": "2024-07-05T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 2,
  "guestName": "Guest One",
  "guestEmail": "guest1@example.com",
  "guestPhone": "+1-555-0001"
}

###
# Booking 2
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 2,
  "checkInDate": "2024-07-01T00:00:00Z",
  "checkOutDate": "2024-07-05T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 2,
  "guestName": "Guest Two",
  "guestEmail": "guest2@example.com",
  "guestPhone": "+1-555-0002"
}

###
# Booking 3
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 2,
  "roomId": 3,
  "checkInDate": "2024-07-10T00:00:00Z",
  "checkOutDate": "2024-07-15T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 4,
  "guestName": "Guest Three",
  "guestEmail": "guest3@example.com",
  "guestPhone": "+1-555-0003"
}

###
# Process all reservations
POST {{baseUrl}}/trigger/process-reservations
Authorization: {{adminToken}}

###
# Check stats
GET {{baseUrl}}/stats
Authorization: {{adminToken}}

###
# View all pending
GET {{baseUrl}}/pending
Authorization: {{adminToken}}

### 14. Booking Cancellation Notification
# Step 1: Create a booking
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 1,
  "checkInDate": "2024-08-01T00:00:00Z",
  "checkOutDate": "2024-08-05T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 2,
  "guestName": "Cancel Test",
  "guestEmail": "cancel@example.com",
  "guestPhone": "+1-555-9999"
}

###
# Step 2: Note the booking ID, then cancel it
POST https://localhost:7001/api/BookHotel/1/cancel
Content-Type: application/json

{
  "cancellationReason": "Testing cancellation notification"
}

###
# Step 3: Process queue (cancellation notifications are queued immediately)
POST {{baseUrl}}/process-queue
Authorization: {{adminToken}}

###
# Step 4: View notifications
GET {{baseUrl}}/pending
Authorization: {{adminToken}}

### ERROR CASES

### 15. Get Notifications Without Auth (Should Fail - 401)
GET {{baseUrl}}/hotel/1

### 16. Get Non-existent Notification (Should Fail - 404)
GET {{baseUrl}}/9999
Authorization: {{adminToken}}

### 17. Trigger Tasks Without Admin Role (Should Fail - 403)
# This would fail if you use a USER token instead of ADMIN
POST {{baseUrl}}/trigger/low-capacity-check
Authorization: Bearer <user-token-here>

### MONITORING AND DEBUGGING

### 18. Check Application Logs
# After triggering tasks, check console output for detailed logs
# Look for lines like:
# [2024-01-15 14:30:00] Running low capacity check...
# [2024-01-15 14:30:00] Sending notification:
# [2024-01-15 14:30:00] Low capacity check complete. Found X alerts.

### 19. Simulate Queue Buildup
# Create multiple bookings rapidly
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 2,
  "checkInDate": "2024-09-01T00:00:00Z",
  "checkOutDate": "2024-09-05T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 2,
  "guestName": "Queue Test 1",
  "guestEmail": "queue1@example.com",
  "guestPhone": "+1-555-0001"
}

###
POST https://localhost:7001/api/BookHotel/book
Content-Type: application/json

{
  "hotelId": 1,
  "roomId": 2,
  "checkInDate": "2024-09-05T00:00:00Z",
  "checkOutDate": "2024-09-10T00:00:00Z",
  "numberOfRooms": 1,
  "numberOfGuests": 2,
  "guestName": "Queue Test 2",
  "guestEmail": "queue2@example.com",
  "guestPhone": "+1-555-0002"
}

###
# Check stats before processing
GET {{baseUrl}}/stats
Authorization: {{adminToken}}

###
# Process queue
POST {{baseUrl}}/process-queue
Authorization: {{adminToken}}

###
# Check stats after processing
GET {{baseUrl}}/stats
Authorization: {{adminToken}}

### 20. View All Notifications for Different Dates
# Check notifications over time
GET {{baseUrl}}/hotel/1
Authorization: {{adminToken}}

###
GET {{baseUrl}}/hotel/2
Authorization: {{adminToken}}
